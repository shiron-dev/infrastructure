- name: Ensure runtime directories
  become: true
  ansible.builtin.file:
    path: "/var/homer"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Ensure assets directory
  become: true
  ansible.builtin.file:
    path: "/var/homer/assets"
    state: directory
    owner: 1000
    group: 1000
    mode: "0755"

- name: Install generated Homer config if present
  become: true
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../data/my-services/homer_config.yml"
    dest: /var/homer/assets/config.yml
    owner: 1000
    group: 1000
    mode: "0644"
  ignore_errors: true

- name: Ensure config exists, otherwise render minimal template
  become: true
  ansible.builtin.template:
    src: config.yml
    dest: /var/homer/assets/config.yml
    mode: "0644"
    owner: 1000
    group: 1000
    force: false

- name: Render docker compose
  become: true
  ansible.builtin.template:
    src: compose.yml
    dest: /var/homer/compose.yml
    mode: "0644"
  notify: Restart homer

- name: Assert Cloudflare tunnel token is provided
  ansible.builtin.assert:
    that:
      - cf_tunnel_token is defined
      - cf_tunnel_token | length > 0
    fail_msg: "cf_tunnel_token must be defined in group_vars for Cloudflare Tunnel"

