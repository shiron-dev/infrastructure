name: Compose CMT CI

on:
  pull_request:
    branches:
      - main
    paths:
      - "compose/**"
      - "tools/compose/**"
      - ".github/workflows/**"

permissions:
  contents: read
  id-token: write

jobs:
  plan:
    name: cmt plan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production-plan
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: ./.github/actions/setup-compose-cmt
        env:
          WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          SERVICE_ACCOUNT: ${{ secrets.SERVICE_ACCOUNT }}
      - name: Verify SSH via Cloudflare Access
        env:
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
        run: |
          set -euo pipefail
          test -n "${CF_ACCESS_CLIENT_ID}"
          test -n "${CF_ACCESS_CLIENT_SECRET}"
          cloudflared access ssh-gen --hostname arm-srv.shiron.dev
          ssh \
            -F compose/ssh_config \
            -o BatchMode=yes \
            -o ConnectTimeout=10 \
            -o StrictHostKeyChecking=accept-new \
            ansible_user@arm-srv.shiron.dev \
            "echo ssh-ok from github-actions"
      - name: Run cmt plan
        id: cmt-plan
        env:
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
        run: |
          set +e

          output_file="$(mktemp)"
          make cmt-plan 2>&1 | tee "$output_file"
          exit_code="${PIPESTATUS[0]}"

          {
            echo "output<<EOF"
            cat "$output_file"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "exit_code=${exit_code}" >> "$GITHUB_OUTPUT"
          rm -f "$output_file"
      - name: Comment cmt plan result
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          header: cmt-plan
          message: |
            ### `make cmt-plan` result

            ```diff
            ${{ steps.cmt-plan.outputs.output }}
            ```
      - name: Fail when cmt plan failed
        if: steps.cmt-plan.outputs.exit_code != '0'
        run: exit 1

