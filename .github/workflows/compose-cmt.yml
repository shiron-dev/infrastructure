name: Compose CMT CI

on:
  pull_request:
    branches:
      - main
    paths:
      - "compose/**"
      - "tools/compose/**"
      - ".github/workflows/**"

permissions:
  contents: read

jobs:
  plan:
    name: cmt plan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: tools/compose/go.mod
          cache-dependency-path: tools/compose/go.sum
      - name: Run cmt plan
        id: cmt-plan
        run: |
          set +e

          output="$(make cmt-plan 2>&1)"
          exit_code=$?

          {
            echo "output<<EOF"
            echo "${output}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "exit_code=${exit_code}" >> "$GITHUB_OUTPUT"
      - name: Comment cmt plan result
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          header: cmt-plan
          message: |
            ### `make cmt-plan` result

            ```diff
            ${{ steps.cmt-plan.outputs.output }}
            ```
      - name: Fail when cmt plan failed
        if: steps.cmt-plan.outputs.exit_code != '0'
        run: exit 1

