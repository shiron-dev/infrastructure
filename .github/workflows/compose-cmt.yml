name: Compose CMT CI

on:
  pull_request:
    branches:
      - main
    paths:
      - "compose/**"
      - "tools/compose/**"
      - ".github/workflows/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

jobs:
  plan:
    name: cmt plan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production-plan
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: ./.github/actions/setup-compose-cmt
        env:
          WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          SERVICE_ACCOUNT: ${{ secrets.SERVICE_ACCOUNT }}
          GH_ACTIONS_SSH_PRIVATE_KEY: ${{ secrets.GH_ACTIONS_SSH_PRIVATE_KEY }}
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
      - name: Verify SSH via Cloudflare Access
        env:
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          TUNNEL_SERVICE_TOKEN_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          TUNNEL_SERVICE_TOKEN_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
        run: |
          echo "CF_ACCESS_CLIENT_ID"
          test -n "${CF_ACCESS_CLIENT_ID}"
          echo "CF_ACCESS_CLIENT_SECRET"
          test -n "${CF_ACCESS_CLIENT_SECRET}"
          echo "TUNNEL_SERVICE_TOKEN_ID"
          test -n "${TUNNEL_SERVICE_TOKEN_ID}"
          echo "TUNNEL_SERVICE_TOKEN_SECRET"
          test -n "${TUNNEL_SERVICE_TOKEN_SECRET}"
          ssh \
            -F compose/ssh_config \
            -o BatchMode=yes \
            -o ConnectTimeout=10 \
            -o StrictHostKeyChecking=accept-new \
            ansible_user@arm-srv.shiron.dev \
            "echo ssh-ok from github-actions"
      - name: Run cmt plan
        id: cmt-plan
        env:
          CMT_OPT: "--exit-status"
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          TUNNEL_SERVICE_TOKEN_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          TUNNEL_SERVICE_TOKEN_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
        run: |
          set +e

          output_file="$(mktemp)"
          make cmt-plan 2>&1 | tee "$output_file"
          exit_code="${PIPESTATUS[0]}"

          {
            echo "output<<EOF"
            cat "$output_file"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          summary_line="$(tr -d '\r' < "$output_file" | awk '/^Summary: /{line=$0} END{print line}')"
          if [ -z "$summary_line" ]; then
            summary_line="Summary: (not found)"
          fi

          echo "summary=${summary_line}" >> "$GITHUB_OUTPUT"
          echo "exit_code=${exit_code}" >> "$GITHUB_OUTPUT"
          cp "$output_file" "$GITHUB_WORKSPACE/plan_output.txt"
          rm -f "$output_file"
      - name: Prepare comment body
        id: prepare-comment
        run: |
          exit_code="${{ steps.cmt-plan.outputs.exit_code }}"
          comment_file="$GITHUB_WORKSPACE/comment_body.md"
          if [ "$exit_code" = "0" ]; then
            echo '### `make cmt-plan` result' > "$comment_file"
            echo "" >> "$comment_file"
            echo "No changes." >> "$comment_file"
          else
            {
              echo '### `make cmt-plan` result'
              echo ""
              echo "${{ steps.cmt-plan.outputs.summary }}"
              echo ""
              echo '```diff'
              cat "$GITHUB_WORKSPACE/plan_output.txt"
              echo '```'
            } > "$comment_file"
          fi
          echo "path=${comment_file}" >> "$GITHUB_OUTPUT"
      - name: Comment cmt plan result
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          header: cmt-plan
          path: ${{ steps.prepare-comment.outputs.path }}
      - name: Fail when cmt plan failed
        if: steps.cmt-plan.outputs.exit_code == '1'
        run: exit 1

