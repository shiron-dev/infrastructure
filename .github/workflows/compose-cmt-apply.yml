name: Compose CMT Apply CI

on:
  push:
    branches:
      - main
    paths:
      - "compose/**"
      - "tools/compose/**"
      - ".github/workflows/**"
  workflow_dispatch:

permissions:
  actions: write
  contents: read
  id-token: write

jobs:
  cancel-stale-runs:
    name: cancel stale runs
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'push'
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = context.ref.replace("refs/heads/", "");
            const currentRunId = context.runId;
            const currentRunNumber = context.runNumber;
            const workflowRef = process.env.GITHUB_WORKFLOW_REF || "";
            const workflowId = workflowRef
              .split("@")[0]
              .replace(`${owner}/${repo}/`, "");

            if (!workflowId) {
              core.warning("Failed to resolve workflow_id from GITHUB_WORKFLOW_REF. Skip stale run cancellation.");
              return;
            }

            const runs = await github.paginate(
              github.rest.actions.listWorkflowRuns,
              {
                owner,
                repo,
                workflow_id: workflowId,
                branch,
                event: "push",
                per_page: 100,
              },
            );

            const activeStatuses = new Set([
              "queued",
              "in_progress",
              "waiting",
              "requested",
              "pending",
              "action_required",
            ]);

            const candidates = runs.filter((run) => {
              if (run.id === currentRunId) return false;
              if (run.run_number >= currentRunNumber) return false;
              if (!activeStatuses.has(run.status)) return false;
              return true;
            });

            let cancelled = 0;

            for (const run of candidates) {
              const jobs = await github.paginate(
                github.rest.actions.listJobsForWorkflowRun,
                {
                  owner,
                  repo,
                  run_id: run.id,
                  per_page: 100,
                },
              );

              const applyJob = jobs.find((job) => job.name === "cmt apply");
              const applyStarted =
                Boolean(applyJob?.started_at) ||
                applyJob?.status === "in_progress" ||
                Boolean(applyJob?.conclusion);

              if (applyStarted) {
                core.info(`Skip run ${run.id}: apply already started.`);
                continue;
              }

              await github.rest.actions.cancelWorkflowRun({
                owner,
                repo,
                run_id: run.id,
              });
              cancelled += 1;
              core.info(`Cancelled stale run ${run.id}.`);
            }

            core.info(`Cancelled ${cancelled} stale run(s).`);

  plan:
    name: cmt plan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production-plan
    if: github.event_name == 'push'
    needs: cancel-stale-runs
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: ./.github/actions/setup-compose-cmt
        env:
          WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          SERVICE_ACCOUNT: ${{ secrets.SERVICE_ACCOUNT }}
          GH_ACTIONS_SSH_PRIVATE_KEY: ${{ secrets.GH_ACTIONS_SSH_PRIVATE_KEY }}
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
      - name: Run cmt plan
        id: cmt-plan
        env:
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          TUNNEL_SERVICE_TOKEN_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          TUNNEL_SERVICE_TOKEN_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
        run: |
          set +e

          output_file="$(mktemp)"
          make cmt-plan 2>&1 | tee "$output_file"
          exit_code="${PIPESTATUS[0]}"
          slack_file="$(mktemp --suffix=.txt)"
          sed -E 's/\x1B\[[0-9;]*[[:alpha:]]//g' "$output_file" | iconv -f UTF-8 -t UTF-8 -c > "$slack_file" || cp "$output_file" "$slack_file"
          if [ ! -s "$output_file" ]; then
            echo "cmt plan produced no output." > "$output_file"
          fi
          if [ ! -s "$slack_file" ]; then
            echo "cmt plan produced no output." > "$slack_file"
          fi

          summary_line="$(tr -d '\r' < "$slack_file" | awk '/^Summary: /{line=$0} END{print line}')"
          if [ -z "$summary_line" ]; then
            summary_line="Summary: (not found)"
          fi

          {
            echo "output_file=${output_file}"
            echo "slack_file=${slack_file}"
            echo "summary=${summary_line}"
            echo "exit_code=${exit_code}"
          } >> "$GITHUB_OUTPUT"
          {
            echo "output_file=${output_file}"
          } >> "$GITHUB_ENV"
      - name: Upload plan result to Slack
        id: slack-upload
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
        with:
          method: files.uploadV2
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          errors: true
          payload: |
            channel_id: ${{ secrets.SLACK_CHANNEL_ID }}
            snippet_type: text
            title: CMT Plan Result (${{ github.repository }})
            filename: cmt-plan-${{ github.run_id }}.txt
            initial_comment: |
              CMT plan result for ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              ${{ steps.cmt-plan.outputs.summary }}
            file: ${{ steps.cmt-plan.outputs.slack_file }}
      - name: Fail when cmt plan failed
        if: steps.cmt-plan.outputs.exit_code != '0'
        run: exit 1

  apply:
    name: cmt apply
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    if: github.event_name == 'push'
    needs: plan
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-apply
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: ./.github/actions/setup-compose-cmt
        env:
          WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          SERVICE_ACCOUNT: ${{ secrets.SERVICE_ACCOUNT }}
          GH_ACTIONS_SSH_PRIVATE_KEY: ${{ secrets.GH_ACTIONS_SSH_PRIVATE_KEY }}
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
      - name: Run cmt apply
        env:
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          TUNNEL_SERVICE_TOKEN_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          TUNNEL_SERVICE_TOKEN_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
        run: make cmt-apply CMT_OPT="--auto-approve"
