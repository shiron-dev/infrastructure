name: Compose CMT Apply CI

on:
  push:
    branches:
      - main
    paths:
      - "compose/**"
      - "tools/compose/**"
      - ".github/workflows/**"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  plan:
    name: cmt plan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production-plan
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: main
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: tools/compose/go.mod
          cache-dependency-path: tools/compose/go.sum
      - name: Run cmt plan
        id: cmt-plan
        run: |
          set +e

          output_file="$(mktemp)"
          make cmt-plan 2>&1 | tee "$output_file"
          exit_code="${PIPESTATUS[0]}"

          echo "output_file=$output_file" >> "$GITHUB_ENV"
          echo "exit_code=${exit_code}" >> "$GITHUB_OUTPUT"
      - name: Write plan result to job summary
        run: |
          echo "## CMT Plan Result" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat "$output_file" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
      - name: Fail when cmt plan failed
        if: steps.cmt-plan.outputs.exit_code != '0'
        run: exit 1

  apply:
    name: cmt apply
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    if: github.event_name == 'push'
    needs: plan
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: main
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: tools/compose/go.mod
          cache-dependency-path: tools/compose/go.sum
      - name: Run cmt apply
        run: make cmt-apply CMT_OPT="--auto-approve"
