name: CMT CI

on:
  pull_request:
    branches:
      - "main"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

defaults:
  run:
    working-directory: tools/compose

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.filter.outputs.src }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            src:
              - ".github/workflows/**"
              - "tools/compose/**"

  cmt-status-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - changes
      - go-test
      - fmt-lint
      - go-generate-diff-check
      - go-vet
      - build
    if: ${{ always() }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Check cmt-status-check
        run: |
          diff \
            <(yq ".jobs | del(.cmt-status-check) | keys.[]" .github/workflows/cmt.yml) \
            <(yq ".jobs.cmt-status-check.needs.[]" .github/workflows/cmt.yml)
      - name: Fail if any needed job failed
        env:
          JOBS: ${{ toJson(needs) }}
        run: |
          for result in $(jq -r '.[].result' <<<"$JOBS"); do
            if [[ ! "$result" =~ ^(success|skipped)$ ]]; then
              exit 1
            fi
          done

  go-test:
    name: Go test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: ${{ needs.changes.outputs.should_run == 'true' }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: tools/compose/go.mod
          cache-dependency-path: tools/compose/go.sum
      - uses: GoTestTools/gotestfmt-action@8b4478c7019be847373babde9300210e7de34bfb # v2.2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Run go test
        run: |
          set -euo pipefail
          go test -json -v ./... 2>&1 | gotestfmt

  fmt-lint:
    name: fmt lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: ${{ needs.changes.outputs.should_run == 'true' }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: tools/compose/go.mod
          cache-dependency-path: tools/compose/go.sum
      - name: Check go fmt
        run: |
          go fmt
      - name: Run golangci-lint
        run: |
          set -euo pipefail
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest
          "$(go env GOPATH)/bin/golangci-lint" run --config .golangci.yml ./...

  go-generate-diff-check:
    name: go generate diff check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: ${{ needs.changes.outputs.should_run == 'true' }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: tools/compose/go.mod
          cache-dependency-path: tools/compose/go.sum
      - name: Run go generate
        run: go generate ./...
      - name: Verify generated files are up to date
        run: git diff --exit-code -- .

  go-vet:
    name: go vet
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: ${{ needs.changes.outputs.should_run == 'true' }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: tools/compose/go.mod
          cache-dependency-path: tools/compose/go.sum
      - name: Run go vet
        run: go vet ./...

  build:
    name: build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: ${{ needs.changes.outputs.should_run == 'true' }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: tools/compose/go.mod
          cache-dependency-path: tools/compose/go.sum
      - name: Build cmt
        run: go build -o cmt .
