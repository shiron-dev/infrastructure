services:
  db:
    image: mariadb:10.11
    container_name: snipeit-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: "please-change-root-password"
      MYSQL_DATABASE: snipeit
      MYSQL_USER: snipeit
      MYSQL_PASSWORD: "please-change-db-password"
    volumes:
      - ./db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p$$MYSQL_ROOT_PASSWORD || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  redis:
    image: redis:alpine
    container_name: snipeit-redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - ./redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s

  snipeit:
    image: snipe/snipe-it:latest
    container_name: snipeit-app
    restart: unless-stopped
    ports:
      - "127.0.0.1:8080:80"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      APP_KEY: "base64:please-generate-and-replace-app-key"
      APP_URL: "https://snipeit.shiron.dev"
      APP_TIMEZONE: Asia/Tokyo
      APP_LOCALE: ja
      DB_CONNECTION: mysql
      DB_HOST: db
      DB_DATABASE: snipeit
      DB_USERNAME: snipeit
      DB_PASSWORD: "please-change-db-password"
      DB_PORT: "3306"
      REDIS_HOST: redis
      REDIS_PASSWORD: "null"
      REDIS_PORT: "6379"
      CACHE_DRIVER: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
    volumes:
      - ./snipeit_data:/var/lib/snipeit
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:80/login >/dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  tunnel-snipeit:
    image: cloudflare/cloudflared:2026.2.0
    container_name: snipeit-tunnel
    restart: unless-stopped
    command: tunnel run
    environment:
      TUNNEL_TOKEN: "please-set-cloudflare-tunnel-token"
    depends_on:
      snipeit:
        condition: service_healthy
