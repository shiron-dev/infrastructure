services:
  snipeit-db:
    image: mariadb:12.2@sha256:b1cb255a9939d28a1856815f0de6046c20c28c21b92a9f2696bc782b247a47ee
    container_name: snipeit-db
    restart: unless-stopped
    environment:
      MARIADB_ROOT_PASSWORD: "{{ .db_root_password }}"
      MARIADB_DATABASE: snipeit
      MARIADB_USER: snipeit
      MARIADB_PASSWORD: "{{ .db_password }}"
    user: "999:999"
    volumes:
      - ./db_data:/var/lib/mysql
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test: ["CMD-SHELL", "mariadb -u $$MARIADB_USER -p$$MARIADB_PASSWORD -e 'SELECT 1' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  snipeit-redis:
    image: redis:8.6.1-alpine@sha256:2afba59292f25f5d1af200496db41bea2c6c816b059f57ae74703a50a03a27d0
    container_name: snipeit-redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes", "--requirepass", "{{ .redis_password }}"]
    user: "1000:1000"
    volumes:
      - ./redis_data:/data
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "{{ .redis_password }}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s

  snipeit-app:
    image: snipe/snipe-it:v8.4.0@sha256:f6f648c419b608926f15e77ed6aaacbe170e0e125595fb23d47a49d5ec222118
    container_name: snipeit-app
    restart: unless-stopped
    depends_on:
      snipeit-db:
        condition: service_healthy
      snipeit-redis:
        condition: service_healthy
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      APP_KEY: "{{ .app_key }}"
      APP_URL: "https://snipeit.shiron.dev"
      APP_TIMEZONE: Asia/Tokyo
      APP_LOCALE: ja
      DB_CONNECTION: mysql
      DB_HOST: snipeit-db
      DB_DATABASE: snipeit
      DB_USERNAME: snipeit
      DB_PASSWORD: "{{ .db_password }}"
      DB_PORT: "3306"
      REDIS_HOST: snipeit-redis
      REDIS_PASSWORD: "{{ .redis_password }}"
      REDIS_PORT: "6379"
      CACHE_DRIVER: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
      TRUSTED_PROXIES: "*"
    volumes:
      - ./snipeit_data:/var/lib/snipeit
    # kics-scan ignore-line
    security_opt:
      - no-new-privileges:false
    cap_drop:
      - ALL
    # kics-scan ignore-line
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - DAC_OVERRIDE
      - FOWNER
      - NET_BIND_SERVICE
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:80/login >/dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  snipeit-tunnel:
    image: cloudflare/cloudflared:2026.2.0@sha256:404528c1cd63c3eb882c257ae524919e4376115e6fe57befca8d603656a91a4c
    container_name: snipeit-tunnel
    restart: unless-stopped
    command: tunnel run
    environment:
      TUNNEL_TOKEN: "{{ .cf_tunnel_token }}"
    depends_on:
      snipeit-app:
        condition: service_healthy
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD", "cloudflared", "version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
